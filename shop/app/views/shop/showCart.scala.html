@(cart:ordercenter.models.Cart)

    @main(){
    <script src="@routes.Assets.versioned("js/jquery.iDialog.min.js")"></script>
    <script type="text/javascript">
    $(function(){

        var FG = window.FG || {};

        // 提示信息
        FG.tip = function (ele, id, msg, x, y, timer) {
            var _timer = 1200;
            var _x = 0;
            var _y = 0;
            if (typeof x === "number") {
                _x = x;
            }
            if (typeof y === "number") {
                _y = y;
            }
            if (typeof timer === "number") {
                _timer = timer;
            }
            var getId = $("#" + id),
                    Left = ele.offset().left + parseInt(_y),
                    Top = ele.offset().top + parseInt(_x),
                    Css = {
                        position: "absolute",
                        left: Left,
                        top: Top,
                        display: "none"
                    };

            if (getId.length > 0) {
                getId.hide();
            } else {
                getId = $("<div>" + msg + "</div>")
                        .attr("id", id)
                        .addClass("com_tip");
                $("body").append(getId);
            }
            getId.css(Css).stop().fadeIn(600);

            window.setTimeout(function () {
                getId.fadeOut(400, function () {
                    getId.remove();
                });
            }, _timer);
        };

        $('#all').click(function(){
            if(this.checked){
                $('.product-list :checkbox').attr('checked',true);
            }else{
                $('.product-list :checkbox').attr('checked',false);
            }
        });

        $('.product-list :checkbox').click(function(){
           var chknum = $('.product-list :checkbox').size();
            var chk = 0;

            $('.product-list :checkbox').each(function(){
               if($(this).is(':checked')){
                   chk++;
               }
            });
            if(chknum == chk){
                $('#all').attr('checked',true);
            }else{
                $('#all').attr('checked',false);
            }

        });


        var cartPage = $('.mycart');

          function setTotalPrice() {
                var totalPrice = 0,proTotalMoney =$('.pro-total-money') ;
                if(proTotalMoney.size()==0){
                    $('.total-price').text('¥' + 0.00);
                    return;
                }
                proTotalMoney.each(function(){
                    totalPrice += parseInt($(this).text(),0);
                });

               var  val = parseInt(totalPrice, 0).toFixed(2);
                $('.total-price').text('¥' + val);
            }

        // 更新数量
        function updateNumber(ele) {
            var numberInput = ele.parent('.amount').find('.text-number'),
                    val = parseInt(numberInput.val(), 0),
                    limit = parseInt(numberInput.attr('limit'), 0),
                    price = parseInt(numberInput.attr('data-price'), 0);
            // 同步更改到数据库
            function sync() {
                var skuId = ele.parent('.amount').attr('data-skuId');
                $.ajax({
                    type: 'POST',
                    url: ' /cart/addSkuToCartReplaceNum?skuId='+skuId+"&number="+val,
                    async: false,
                    dataType: 'JSON',
                    success: function (result) {
                        if (result.result) {
                         //产品单品总价
                            updatePrice(ele,val,price);
                            //总价
                            setTotalPrice();

                        }
                    }
                });
            }

            function updatePrice(ele,val,price){
                ele.parents('tr').find('.pro-total-money').text((val*price).toFixed(2));
            }



            return {
                add: function () {
                    val += 1;

                    if (val > limit) {
                        val = limit;
                        FG.tip(numberInput, 'limit-tip', '超出此商品能购买的最大数量', 30);
                        return;
                    }

                    numberInput.val(val);


                    sync();

                },
                remove: function () {
                    val -= 1;

                    if (val < 1) {
                        val = 1;
                         return;
                    }

                    numberInput.val(val);
                    setTotalPrice(val * price);
                    sync();
                },
                checkValue: function () {

                    if (!/^[1-9]*\d*$/g.test(val)) {
                        val = 1;
                    }

                    if (val < 1) {
                        val = 1;
                    }

                    if (val > limit) {
                        val = limit;
                        FG.tip(numberInput, 'limit-tip', '超出此商品能购买的最大数量', 30);
                         return;
                    }

                    numberInput.val(val);
                    setTotalPrice(val * price);
                    sync();
                }
            };

        }

        // 增加数量事件
        cartPage.on('click', '.btn-add', function () {
            updateNumber($(this)).add();
        });

        // 减小数量事件
        cartPage.on('click', '.btn-sub', function () {
            updateNumber($(this)).remove();
        });

        // 手动输入数量验证
        cartPage.on('blur', '.text-number', function () {
            updateNumber($(this)).checkValue();
        });

            //提交购物车
   $('#toOrder').click(function(){
        var checkboxs = $('.product-list :checkbox'),cartItem=[];
        checkboxs.each(function(){
          if($(this).is(':checked')){
                  cartItem.push($(this).attr('value'));
               }
        });

        if(cartItem.length<1){
                        $.dialog({
                        title:'提示',
                        content:'请选择要购买的商品',
                        width:300,
                        padding:'30px'
                    });
            return;
        }

           $.ajax({
            type: "post",
            url: '/cart/selCartItemProcess?selCartItems='+cartItem.join(','),
            async: false,
            dataType: 'json',
            cache: false,
            success: function (data) {
                if(data.result){
                    window.location.href = '/cart/chooseAddress?selCartItems='+cartItem.join(',');
                }
            }
        });

   });





   //删除购物车
   $('.product-list .del').click(function(){
            var that = $(this),globalcartId = that.attr('data-id');
            $.dialog({
                title:'提示',
                content:'您确定要删除这条数据吗？',
                width:300,
                padding:'30px',
                btn: {
                    ok: {
                        val: '确定',
                        type: 'red',
                        click: function(btn) {
                             $.ajax({
                                type: 'POST',
                                url:'/cart/deleteCartItem?cartItemId='+globalcartId,
                                dataType: 'json',
                                success: function (data) {
                                   if(data.result){
                                        that.parents('tr').remove();
                                        if(that.parents('tbody').find('tr').size() == 0){
                                            $('.mycart-list').remove();
                                            $('.mycart-inner').append("<div class='mycart-empty'><p>购物车里空空如也，赶紧去 <a href='index.html'>逛逛吧&gt;</a></p></div>");
                                        }
                                        setTotalPrice();
                                   }
                                }
                            });
                        }
                    },
                    cancle: {
                        val: '取消'
                    }
                }
            });
   });


   });






/*

获取库存信息，用于前端数据验证(最大购买数限制、和库存)
http://localhost:9000/cart/getSkuStorage?skuId=5585

添加购物车-通过累加的方式增加同一个购物车项购买个数
添加商品1：
http://localhost:9000/cart/addSkuToCartAddNum?skuId=5579&number=2
添加商品2：
http://localhost:9000/cart/addSkuToCartAddNum?skuId=5587&number=2

添加购物车-通过替换的方式增加同一个购物车项购买个数
添加商品1：
http://localhost:9000/cart/addSkuToCartReplaceNum?skuId=5579&number=10
添加商品2：
http://localhost:9000/cart/addSkuToCartReplaceNum?skuId=5587&number=10

查看用户购物车：
http://localhost:9000/cart/showCart

选择寄送地址：
http://localhost:9000/cart/chooseAddress

 */

</script>
    } {
        <div class="mycart width1200">
            <div class="mycart-inner">
                <div class="mycart-step">
                    <div class="step-bg"></div>
                    <ul class="clearfix">
                        <li class="current">我的购物车</li>
                        <li>提交订单</li>
                        <li class="last">选择支付方式</li>
                    </ul>
                </div>

                @if(cart == null || cart.getCartItemList == null || cart.getCartItemList.size() == 0) {
                        <!-- mycart empty-->
                    <div class="mycart-empty">
                        <p>购物车里空空如也，赶紧去 <a href="index.html">逛逛吧></a></p>
                    </div>
                        <!-- end mycart empty-->
                    } else {
                    <!-- mycart-list -->
                    <div class="mycart-list">
                        <h3>购物车</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th><label for="all"><input type="checkbox" id="all"> 全选 </label></th>
                                    <th class="col1"></th>
                                    <th>商品信息</th>
                                    <th>细节</th>
                                    <th>单价</th>
                                    <th>数量</th>
                                    <th>小计</th>
                                    <th class="action">操作</th>
                                </tr>
                            </thead>
                            <tbody class="product-list">
                            @for(cartItem <- cart.getCartItemList) {
                                <tr>
                                    <td>
                                        <input type="checkbox"  value="@cartItem.getId" />
                                    </td>
                                    <td>
                                        <img src="@cartItem.getMainPicture" alt=""/><!--此拿到的只是图的url地址，可能没有值-->
                                    </td>
                                    <td>
                                        <div class="pro-info">
                                            <p class="pro-name">@cartItem.getProductName</p>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                        @if(cartItem.getSku != null && cartItem.getSku.getSkuProperties != null) {
                                            @for(property <- cartItem.getSku.getSkuProperties) {
                                                <p>@property.getPropertyName ： @property.getPropertyValue</p>
                                            }
                                        }
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <p class="actual-price">￥@cartItem.getCurUnitPrice</p>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="amount" data-skuId="@cartItem.getSkuId">
                                            <a href="javascript:void(0);" class="btn-sub"><span>-</span></a>
                                            <input type="text" size="3" maxlength="3" class="text-number" limit="@cartItem.getTradeMaxNumber" value="@cartItem.getNumber" data-price="@cartItem.getCurUnitPrice">
                                            <a href="javascript:void(0);" class="btn-add"><span>+</span></a>
                                        </div>
                                    </td>
                                    <td>
                        ￥<span class="pro-total-money">@cartItem.getTotalPrice</span>
                    </td>
                                    <td>
                                        <span  class="btn del" title="删除" data-id="@cartItem.getId">X</span>
                                    </td>
                                </tr>
                            }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="6"></td>
                                    <td>商品总计：</td>
                                    <td class="total-price">￥@cart.getTotalMoney</td>
                                </tr>
                                <tr>
                                    <td colspan="6"></td>
                                    <td colspan="2">
                                        <span class="btn toOrder" id="toOrder">去结算</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div><!-- end mycart-list -->
                }
            </div>
        </div>
    }
